#!@SHELL@
# -*- shell-script -*-

TOP_SRCDIR='@abs_top_srcdir@'
TOP_BUILDDIR='@abs_top_builddir@'

TMPLDIR="$TOP_SRCDIR/test/tmpl"
SGMLDIR='sgml'

#DOKIDOC_SCAN="$TOP_BUILDDIR/src/dokidoc-scan/.libs/lt-dokidoc-scan"
DOKIDOC_SCAN="$TOP_BUILDDIR/src/dokidoc-scan/dokidoc-scan"
DOKIDOC_UPDATE="$TOP_BUILDDIR/src/dokidoc-update/dokidoc-update"
DOKIDOC_SGML="$TOP_BUILDDIR/src/dokidoc-sgml/dokidoc-sgml"

export G_DEBUG='gc-friendly'
export G_SLICE='all'
export DOKIDOC_SCANNERSDIR="$TOP_BUILDDIR/src/dokidoc-scan/scanner-c"

# valgrind \
#     --tool=memcheck \
#     --leak-check=yes \
#     --show-possibly-lost=yes \
#     --leak-resolution=high \
#     --show-reachable=yes \
#     --undef-value-errors=yes \
#     --fullpath-after= \
#     --num-callers=50 \
#     --show-below-main=yes \
#     --read-var-info=yes \
#     --gen-suppressions=all \
#     "$DOKIDOC_SCAN" dokidoc-test-scan.conf

"$DOKIDOC_SCAN" dokidoc-test-scan.conf || exit 1

# [FIXME]
test -d "$TMPLDIR" || mkdir -vp "$TMPLDIR"
test -d "$SGMLDIR" || mkdir -vp "$SGMLDIR"

"$DOKIDOC_UPDATE" dokidoc-test-scan.conf || exit 1

"$DOKIDOC_SGML" dokidoc-test-scan.conf || exit 1

# "$DOKIDOC_UPDATE" -i source1.xml

xalan -in sgml/dokidoc.sgml -xsl /usr/share/xml/docbook/stylesheet/docbook-xsl/html/docbook.xsl -out dokidoc.html || exit 1
